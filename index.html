<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أوقات الصلاة في الشارقة 1446 هـ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #canvas-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
        }
        .message {
            text-align: center;
            margin: 20px;
            color: #666;
        }
        .error-message {
            color: #d9534f;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            padding: 15px;
            border: 1px solid #d9534f;
            border-radius: 5px;
            background-color: #f9f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="message" class="message">... انتظر لحظة</div>
        <div id="canvas-container"></div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Display current date
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

        // Your PDF URL - replace with your actual PDF URL
        const pdfUrl = './shjprayertimes.pdf';

        // PDF date range configuration
        // IMPORTANT: Update these dates to match your PDF's first and last dates
        const pdfStartDate = new Date('2024-07-07'); // First date in the PDF
        const pdfEndDate = new Date('2025-06-25');   // Last date in the PDF

        // Calculate which page to display based on date
        function getPageForToday(today) {
            // Check if today is within the PDF's date range
            if (today < pdfStartDate) {
                return -1; // Before PDF start date
            }
            if (today > pdfEndDate) {
                return -2; // After PDF end date
            }
            
            // Calculate days since PDF start date
            const daysSinceStart = Math.floor((today - pdfStartDate) / (24 * 60 * 60 * 1000));
            
            // Assuming 1 page per day, with page 1 being the first date
            return daysSinceStart + 1;
        }

        // Render the specific page from the PDF
        async function renderPage() {
            const messageElement = document.getElementById('message');
            const canvasContainer = document.getElementById('canvas-container');
            const pageNum = getPageForToday(today);
            
            // Handle out-of-range dates
            if (pageNum === -1) {
                // Date before PDF start date
                showErrorMessage(`The prayer times for today are not available. The calendar starts from ${pdfStartDate.toLocaleDateString('en-US', options)}.`);
                return;
            } else if (pageNum === -2) {
                // Date after PDF end date
                showErrorMessage(`The prayer times for today are not available. The calendar only goes up to ${pdfEndDate.toLocaleDateString('en-US', options)}.`);
                return;
            }
            
            try {
                // Load the PDF with better options
                const loadingTask = pdfjsLib.getDocument({
                    url: pdfUrl,
                    cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/',
                    cMapPacked: true,
                });
                
                const pdf = await loadingTask.promise;
                
                // Check if the requested page exists
                if (pageNum > pdf.numPages) {
                    showErrorMessage('Error: The requested page does not exist in the PDF.');
                    return;
                }
                
                // Get the specific page
                const page = await pdf.getPage(pageNum);
                
                // Get the device pixel ratio
                const pixelRatio = window.devicePixelRatio || 1;
                
                // Calculate a better scale based on container size
                const container = document.querySelector('.container');
                const containerWidth = container.clientWidth - 40; // Accounting for padding
                
                // Get the original dimensions
                const viewport = page.getViewport({ scale: 1.0 });
                
                // Calculate scale to fit container width
                const scaleToFit = containerWidth / viewport.width;
                
                // Create a higher resolution viewport for rendering
                const scaledViewport = page.getViewport({ 
                    scale: scaleToFit * pixelRatio * 1.5 // Higher scale for better quality
                });
                
                // Create canvas element
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { alpha: false });
                
                // Set physical size for high resolution
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                
                // Set display size
                canvas.style.height = `${scaledViewport.height / pixelRatio}px`;
                canvas.style.width = `${scaledViewport.width / pixelRatio}px`;
                
                // Clear the loading message and append canvas
                messageElement.style.display = 'none';
                canvasContainer.appendChild(canvas);
                
                // Render the page with improved options
                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport,
                    intent: 'print', // 'print' provides higher quality than 'display'
                    renderInteractiveForms: false,
                    canvasFactory: {
                        create: function(width, height) {
                            return {
                                canvas: canvas,
                                context: context
                            };
                        },
                        reset: function(canvasAndContext, width, height) {
                            canvasAndContext.context.setTransform(1, 0, 0, 1, 0, 0);
                            canvasAndContext.context.clearRect(0, 0, width, height);
                            return canvasAndContext;
                        }
                    }
                }).promise;
                
            } catch (error) {
                showErrorMessage('Error loading prayer times: ' + error.message);
                console.error('Error rendering PDF:', error);
            }
        }

        function showErrorMessage(message) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.classList.remove('message');
            messageElement.classList.add('error-message');
        }

        // Run when the page loads
        document.addEventListener('DOMContentLoaded', renderPage);
    </script>
</body>
</html>